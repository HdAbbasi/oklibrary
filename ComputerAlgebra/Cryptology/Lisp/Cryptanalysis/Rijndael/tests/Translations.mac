/* Matthew Gwynne, 19.8.2008 (Swansea) */
/* Copyright 2008, 2009, 2010, 2011 Oliver Kullmann
This file is part of the OKlibrary. OKlibrary is free software; you can redistribute
it and/or modify it under the terms of the GNU General Public License as published by
the Free Software Foundation and included in this library; either version 3 of the
License, or any later version. */

/*!
  \file ComputerAlgebra/Cryptology/Lisp/Cryptanalysis/Rijndael/tests/Translations.mac
  \brief Tests for the AES translation functions

Use by

oklib_load("OKlib/ComputerAlgebra/Cryptology/Lisp/Cryptanalysis/Rijndael/tests/Translations.mac");

  \bug DONE (old code removed)
  C-STACK overflow
  <ul>
   <li> When running at test-level "full" we get the error
   \verbatim
okltest_aes_key_expansion_cp(aes_key_expansion_cp)
Maxima encountered a Lisp error:

 C-STACK overflow at size 557056. Stack can probably be resized.

Automatically continuing.
   \endverbatim
   </li>
   <li> Is there really a stack problem? </li>
  <ul>

*/

/*!
\htmlonly
*/

oklib_include("OKlib/ComputerAlgebra/TestSystem/Lisp/Asserts.mac")$
oklib_include("OKlib/ComputerAlgebra/Cryptology/Lisp/Cryptanalysis/Rijndael/Translations.mac")$

kill(f)$

okltest_aes_mul_ts_gen(f) := block([FF],
  if oklib_test_level = 0 then return(true),
  FF : f(2),
  assert(length(FF[1]) = 16+256),
  assert(elementp(setify(create_list(dts_var(i),i,1,256)),setify(FF[2]))),
  assert(elementp({11,-dts_var(256)}, setify(FF[2]))),
  assert(elementp({-12,-9,-5,-2,1,3,4,6,7,8,10,11,13,14,15,16,dts_var(10)},
    setify(FF[2]))),
  FF : f(3),
  assert(length(FF[1]) = 16+256),
  assert(elementp(setify(create_list(dts_var(i),i,1,256)),setify(FF[2]))),
  assert(elementp({11,-dts_var(256)}, setify(FF[2]))),
  assert(elementp({-12,-9,-4,-3,-2,1,5,6,7,8,10,11,13,14,15,16,dts_var(10)},
    setify(FF[2]))),
  if oklib_test_level = 1 then return(true),
  for e in [9,11,13,14] do (
    FF : f(e),
    assert(length(FF[1]) = 16+256),
    assert(elementp(setify(create_list(dts_var(i),i,1,256)),setify(FF[2])))),
  true)$


okltest_aes_sbox_ts_gen(f) := block([FF],
  if oklib_test_level = 0 then return(true),
  FF : f(),
  assert(length(FF[1]) = 16+256),
  assert(elementp(setify(create_list(dts_var(i),i,1,256)),setify(FF[2]))),
  assert(elementp({-11,-dts_var(90)}, setify(FF[2]))),
  assert(elementp({-12,-9,-7,-6,-4,-1,2,3,5,8,10,11,13,14,15,16,dts_var(10)},
    setify(FF[2]))),
  true)$

/******************************************************************
 * Statistics                                                     *
 ******************************************************************
*/

okltest_nsbox_ss_csttl(f) := block([n : 4],
  if oklib_test_level = 0 then n : 2,
  for r : 1 thru n do block([csttl],
    for c : 1 thru n do (
      for rw : 1 thru n do (
        csttl : ss_csttl(r,c, rw, 4, false, aes_mc_forward),
        assert(
          length(sublist(csttl,
              lambda([C], is(cstt_name(C) = "ss_sbox_cst")))) =
          f(r,c,rw))))),
  true)$

okltest_nmul_ss_csttl(f) := block([n : 4, rowcols : [1,2,4]],
  if oklib_test_level = 0 then (n : 1,rowcols : [1,2]),
  for e in ['x,'x+1] do
    for r : 1 thru n do block([csttl],
      for c in rowcols do (
        for rw in rowcols do (
          csttl : ss_csttl(r,c, rw, 4, false, aes_mc_forward),
          assert(
            length(sublist(csttl,
                lambda([C],is(cstt_name(C) = "ss_mul_cst") and
                  is(C[3] = e)))) =
            f(e,r,c,4,ss_mixcolumns_matrix(2,4,rw),false,aes_mc_forward))))),
  true)$

okltest_nvar_ss_fcl(f) := (
  assert(f(1,1,1,4,ss_mixcolumns_matrix(2,4,1),16,
      [['x,16],['x+1,16]],false,aes_mc_forward) = 64),
  assert(f(1,4,4,8,ss_mixcolumns_matrix(2,8,4),256,
      [['x,256],['x+1,256], [x^3+1,256],[x^3+x+1,256],[x^3+x^2+1,256],
      [x^3+x^2+x,256]],false,aes_mc_bidirectional) = 31400),
  true)$

/******************************************************************
 * Data translation                                               *
 ******************************************************************
*/

okltest_aes_hex2pa(f) := block(
  assert(f("",[]) = {}),
  assert(f("0",[1,2,3,4,5,6,7,8]) = {-8,-7,-6,-5,-4,-3,-2,-1}),
  assert(f("00",[1,2,3,4,5,6,7,8]) = {-8,-7,-6,-5,-4,-3,-2,-1}),
  assert(f("01",[1,2,3,4,5,6,7,8]) = {8,-7,-6,-5,-4,-3,-2,-1}),
  assert(f("A5",[1,2,3,4,5,6,7,8]) =  {-7,-5,-4,-2,1,3,6,8}),
  assert(f("54A5",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]) = 
    {-15,-13,-12,-10,-8,-7,-5,-3,-1,2,4,6,9,11,14,16}),
  true)$

okltest_ss_random_matrix(f) := block(
  set_random_state(make_random_state(0)),
  assert(f(2,4,ss_polynomial_2_4,1,1) = matrix([x^3+x^2])),
  set_random_state(make_random_state(0)),
  assert(f(2,8,ss_polynomial_2_8,4,4) =
    matrix([x^7+x^5+x^3+x^2,x^5+x^3+x^2+x+1,x^6+x^5+x^4+x^2+1,x^7+x^6],
      [x^6+x+1,x^7+x^6+x^5+x^4+x^3+x+1,x^7+x^6+x+1,x^6+x^5+x^2+x+1],
      [x^3+1,x^7+x^6+x^4+x+1,x^4+x^2+1,x^7+x^6+x^5+x^4+x],
      [x^5+x^2,x^6+x^4+x^2+x+1,x^6+x^2+x,x^7+x^6+x^4+x^3])),
  true)$

okltest_ss_matrix2pa(f) := block(
  assert(f(matrix(),[],2,1,1) = []),
  assert(f(matrix([1]),[1],2,1,1) = [1]),
  assert(f(matrix([1],[0]),[1,2],2,1,1) = [1,-2]),
  assert(f(matrix([x^6+x^4+x^3,x^7+x^3+x^2,x^5+x^4+x^3+x,x^7+x^6+1],
        [x^7+x^6+x^5+x^2+x,x^5+x^2+x+1,x^6+x^4+x^2+x+1,x^7+x^5+x^3+x^2+x],
        [x^6+x^4+x^3,x^6+x^4+1,x^7+x^5+x^2+1,x^4+x^3+1],
        [x^6+x^3+x^2+1,x^6+x^3,x^3+1,x^7+x^4+x^2]),create_list(i,i,1,128),
      2,8,ss_polynomial_2_8) =
      [-1,2,-3,4,5,-6,-7,-8,9,10,11,-12,-13,14,15,-16,-17,18,-19,20,21,
      -22,-23,-24,-25,26,-27,-28,29,30,-31,32,33,-34,-35,-36,37,38,-39,
      -40,-41,-42,43,-44,-45,46,47,48,-49,50,-51,52,-53,-54,-55,56,-57,
      58,-59,-60,61,-62,-63,-64,-65,-66,67,68,69,-70,71,-72,-73,74,-75,76,
      -77,78,79,80,81,-82,83,-84,-85,86,-87,88,-89,-90,-91,-92,93,-94,-95,
      96,97,98,-99,-100,-101,-102,-103,104,105,-106,107,-108,109,110,111,
      -112,-113,-114,-115,116,117,-118,-119,120,121,-122,-123,124,-125,126,
      -127,-128]),
  true)$

okltest_ss_pa2matrix(f) := block(
  assert(f([],[],2,1,1,1) = matrix()),
  assert(f([1],[1],2,1,1,1) = matrix([1])),
  assert(f([1,-2],[1,2],2,1,1,2) = matrix([1],[0])),
  assert(f([-1,2,-3,4,5,-6,-7,-8,9,10,11,-12,-13,14,15,-16,-17,18,-19,20,21,
      -22,-23,-24,-25,26,-27,-28,29,30,-31,32,33,-34,-35,-36,37,38,-39,
      -40,-41,-42,43,-44,-45,46,47,48,-49,50,-51,52,-53,-54,-55,56,-57,
      58,-59,-60,61,-62,-63,-64,-65,-66,67,68,69,-70,71,-72,-73,74,-75,76,
      -77,78,79,80,81,-82,83,-84,-85,86,-87,88,-89,-90,-91,-92,93,-94,-95,
      96,97,98,-99,-100,-101,-102,-103,104,105,-106,107,-108,109,110,111,
      -112,-113,-114,-115,116,117,-118,-119,120,121,-122,-123,124,-125,126,
      -127,-128],create_list(i,i,1,128),2,8,ss_polynomial_2_8,4) =
    matrix([x^6+x^4+x^3,x^7+x^3+x^2,x^5+x^4+x^3+x,x^7+x^6+1],
        [x^7+x^6+x^5+x^2+x,x^5+x^2+x+1,x^6+x^4+x^2+x+1,x^7+x^5+x^3+x^2+x],
        [x^6+x^4+x^3,x^6+x^4+1,x^7+x^5+x^2+1,x^4+x^3+1],
        [x^6+x^3+x^2+1,x^6+x^3,x^3+1,x^7+x^4+x^2])),
  true)$

/*!
\endhtmlonly
*/
