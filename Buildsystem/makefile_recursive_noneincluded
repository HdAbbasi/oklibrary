sub_makes := $(dir $(shell cd $(srcdir); find * -mindepth 1 -maxdepth 1 -name "makefile"))

define run_all_makes
  for sm in $(sub_makes); do cd $(srcdir); $(MAKE) -C $${sm} $@; if [ $$? != 0 ]; then exit 1; fi; done
endef

define run_all_makes_ignorant
  for sm in $(sub_makes); do $(MAKE) -C $${sm} $@ --ignore-errors; done
endef

all $(normal_goals) $(cleaning_goals) $(test_goals) $(forced_goals) :
	$(run_all_makes)

$(special_goals) :
ifeq ($(MAKELEVEL), 0)
	$(run_all_makes_ignorant)
endif
	$(run_all_makes)
