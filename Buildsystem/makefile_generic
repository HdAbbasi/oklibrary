# Oliver Kullmann, 6.3.2002 (Swansea)

#ToDo: Updating the following comments

# Generic makefile, to be used in a general environment for C++
# compilation

# Usage:

# make all
# = make unoptimsed + make optimised

# make unoptimised
# creates all dependencies files, object files, and program files;

# make optimised
# creates the same (names of object and program files modified), but using optimisation options;

# make prebuild
# creates all directories and header files

# make check
# = make test + make testop

# make test
# recompiles the test program if necessary, and runs the test if necessary.

# make testop
# recompiles the test program with optimisation if necessary, and runs the test if necessary.

# make clean
# = make cleanobj cleandep
# make cleanall
# = make clean cleanhead cleanprograms

# Programs are compiled with $(CXX), while objectsfiles are compiled with $(CXX) resp. $(CC)
# in case the suffix is .cpp resp. .c .

SHELL = /bin/sh
.SUFFIXES :

define last-element
$(word $(words $1),$1)
endef

ifndef srcdir

this-makefile := $(call last-element,$(MAKEFILE_LIST))
other-makefiles := $(filter-out $(this-makefile),$(MAKEFILE_LIST))
parent-makefile := $(call last-element,$(other-makefiles))
srcdir := $(shell cd $(dir $(parent-makefile)); pwd)

endif

ifndef OKBuildsystem
  ifdef OKBUILDSYSTEM
    OKBuildsystem := $(OKBUILDSYSTEM)
  else
    $(error Either OKBuildsystem or OKBUILDSYSTEM must be defined!)
  endif
endif

export

include $(OKBuildsystem)/makefile_standardgoals

export

include $(srcdir)/makefile.definitions.mak

# Definitions required from makefile.definitions:
# General_options
# Optimisation_options
# test_program
# programs
# source_libraries
# link_libraries
# Root

# ToDo: Only Root should stay, while the rest is handled by
# THIS makefile, inspecting its directory and all subdirectories,
# and collecting the required information individually from
# all .hpp and .cpp files by means of annotating files.

source_libraries += -I$(srcdir)

prefix := $(shell cd $(srcdir); cd $(Root); pwd)

exec_prefix := $(prefix)
bindir := $(exec_prefix)/bin
libdir := $(exec_prefix)/lib

includedir := $(prefix)/include

aux_dir := $(prefix)/aux

Directories := $(bindir) $(libdir) $(includedir) $(aux_dir)

# -----------------------------------------------------------------------------------

test_program := $(addprefix $(bindir)/, $(test_program))

programs := $(addprefix $(bindir)/, $(programs))
programs += $(test_program)

# ---------------------------------------------------

name_addition := $(strip $(Optimisation_options))
All_options := $(General_options) $(Optimisation_options)

programs_optimised := $(programs:=$(name_addition))

header_files_cpp := $(wildcard $(srcdir)/*.hpp)
header_files_cpp := $(notdir $(header_files_cpp))
header_files_cpp :=  $(addprefix $(includedir)/, $(header_files_cpp))
header_files_c := $(wildcard $(srcdir)/*.h)
header_files_c := $(notdir $(header_files_c))
header_files_c :=  $(addprefix $(includedir)/, $(header_files_c))
header_files := $(header_files_cpp) $(header_files_c)

compilation_units_cpp := $(wildcard $(srcdir)/*.cpp)
compilation_units_cpp := $(notdir $(compilation_units_cpp))
compilation_units_c := $(wildcard $(srcdir)/*.c)
compilation_units_c := $(notdir $(compilation_units_c))

dependency_files_cpp := $(compilation_units_cpp:.cpp=.d)
dependency_files_cpp := $(addprefix $(aux_dir)/, $(dependency_files_cpp))
dependency_files_c := $(compilation_units_c:.c=.d) 
dependency_files_c := $(addprefix $(aux_dir)/, $(dependency_files_c))
dependency_files := $(dependency_files_cpp) $(dependency_files_c)

object_files_cpp := $(compilation_units_cpp:.cpp=.o) 
object_files_cpp := $(addprefix $(libdir)/, $(object_files_cpp))
object_files_c := $(compilation_units_c:.c=.o)
object_files_c := $(addprefix $(libdir)/, $(object_files_c))
object_files := $(object_files_cpp) $(object_files_c)
object_files_cpp_optimised := $(compilation_units_cpp:.cpp=$(name_addition).o)
object_files_cpp_optimised := $(addprefix $(libdir)/, $(object_files_cpp_optimised))
object_files_c_optimised := $(compilation_units_c:.c=$(name_addition).o)
object_files_c_optimised := $(addprefix $(libdir)/, $(object_files_c_optimised))
object_files_optimised := $(object_files_cpp_optimised) $(object_files_c_optimised)

# ----------------------------------------------------------------

all : unoptimised optimised

prebuild : $(Directories) $(header_files) 

unoptimised : $(programs) $(object_files)
# ToDo: not all object files should be listed in the prerequisites, but
# only those that are that just the .o-forms of programs

optimised : $(programs_optimised) $(object_files_optimised)
# ToDo: Same as for "unoptimised"

check : test testop

test : $(test_program)
	$(test_program)
	touch test
testop : $(test_program)$(name_addition)
	$(test_program)$(name_addition)
	touch testop

force :

# ---------------------------------------------------------------

ifeq ($(firstword $(filter $(special_goals) $(cleaning_goals) $(forced_goals), $(MAKECMDGOALS))),)
include $(dependency_files)
endif

$(Directories) : % :
	mkdir $@

$(header_files_cpp) : $(includedir)/%.hpp : $(srcdir)/%.hpp
	cp $< $@
$(header_files_c) : $(includedir)/%.h : $(srcdir)/%.h
	cp $< $@


# ToDo (PROBLEM):
# If one is using different paths due to symbolic links, then the
# dependency files contain unusable information (and must be
# deleted with "make cleandep").
# This problem seems hard to solve (one had to find out that
# different paths lead to the same file).
# So it must be documented well.
$(dependency_files_cpp) : $(aux_dir)/%.d : $(srcdir)/%.cpp
	$(CXX) -MM -MF $@ -MT $(libdir)/$*.o -MT $(libdir)/$*$(name_addition).o -MT $@ $(source_libraries) $<
$(dependency_files_c) : $(aux_dir)/%.d : $(srcdir)/%.c
	$(CC) -MM -MF $@ -MT $(libdir)/$*.o -MT $(libdir)/$*$(name_addition).o -MT $@ $(source_libraries) $<

$(object_files_cpp_optimised) : $(libdir)/%$(name_addition).o : $(srcdir)/%.cpp
	$(CXX) -c -o $@ $(CPPFLAGS) $(CXXFLAGS) $(Optimisation_options) $(source_libraries) $<
$(object_files_cpp) : $(libdir)/%.o : $(srcdir)/%.cpp
	$(CXX) -c -o $@ $(CPPFLAGS) $(CXXFLAGS) $(General_options) $(source_libraries) $<

$(object_files_c_optimised) : $(libdir)/%$(name_addition).o : $(srcdir)/%.c
	$(CC) -c -o $@ $(CPPFLAGS) $(CFLAGS) $(Optimisation_options) $(source_libraries) $<
$(object_files_c) : $(libdir)/%.o : $(srcdir)/%.c
	$(CC) -c -o $@ $(CPPFLAGS) $(CFLAGS) $(General_options) $(source_libraries) $<


define get-link_libraries
$$(if [[ -e $(srcdir)/$(notdir $@).link_libraries ]]; then $(srcdir)/$(notdir $@).link_libraries; else echo $(link_libraries); fi)
endef

export

$(programs) : $(bindir)/% : $(libdir)/%.o
	$(CXX) -o $@ $(General_options) $< $(get-link_libraries)
$(programs_optimised) : $(bindir)/% : $(libdir)/%.o
	$(CXX) -o $@ $(Optimisation_options) $< $(get-link_libraries)


# --------------------------------

cleanobj :
	- rm $(object_files) $(object_files_optimised)

cleandep :
	- rm $(dependency_files)

clean : cleanobj cleandep
	- rm test testop

cleanhead :
	- rm $(header_files)

cleanprograms :
	- rm $(programs) $(programs_optimised)

cleanall : clean cleanhead cleanprograms

