# Oliver Kullmann, 6.3.2002 (Swansea)

# Generic makefile, to be used in a general environment for C++
# compilation

# Usage:

# make all
# = make unoptimsed + make optimised

# make unoptimised
# creates all dependencies files, object files, header files and program files;

# make optimised
# creates the same (names of object and program files modified), but using optimisation options;

# make file.d, file.o, file.hpp, program 
# creates the respective file;

# make check
# = make test + make testop

# make test
# recompiles the test program if necessary, and runs the test if necessary.

# make testop
# recompiles the test program with optimisation if necessary, and runs the test if necessary.


SHELL = /bin/sh
.SUFFIXES :

include makefile.definitions

# Definitions required from makefile.definitions:
# General_options
# Optimisation_options
# test_program
# source_libraries
# link_libraries
# Root

srcdir := $(shell pwd)

source_libraries += -I$(srcdir)

prefix := $(shell cd $(Root); pwd)

exec_prefix := $(prefix)
bindir := $(exec_prefix)/bin
libdir := $(exec_prefix)/lib

includedir := $(prefix)/include

aux_dir := $(prefix)/aux

Directories := $(bindir) $(libdir) $(includedir) $(aux_dir)

# -----------------------------------------------------------------------------------

test_program := $(addprefix $(bindir)/, $(test_program))

programs := $(addprefix $(bindir)/, $(programs))
programs += $(test_program)

# ---------------------------------------------------

name_addition := $(strip $(Optimisation_options))
All_options := $(General_options) $(Optimisation_options)

programs_optimised := $(programs:=$(name_addition))

header_files := $(wildcard $(srcdir)/*.hpp)
header_files := $(notdir $(header_files))
header_files :=  $(addprefix $(includedir)/, $(header_files))

compilation_units := $(wildcard $(srcdir)/*.cpp)
compilation_units := $(notdir $(compilation_units))

dependency_files := $(compilation_units:.cpp=.d)
dependency_files := $(addprefix $(aux_dir)/, $(dependency_files))

object_files := $(compilation_units:.cpp=.o)
object_files := $(addprefix $(libdir)/, $(object_files))
object_files_optimised := $(compilation_units:.cpp=$(name_addition).o)
object_files_optimised := $(addprefix $(libdir)/, $(object_files_optimised))

# ----------------------------------------------------------------

.PHONY : prebuild all unoptimised optimised check clean cleanall force

all : unoptimised optimised

prebuild : $(Directories) $(header_files) 

unoptimised : $(object_files) $(programs)

optimised : $(object_files_optimised) $(programs_optimised)

check : test testop

test : $(Directories) $(test_program)
	$(test_program)
	touch test
testop : $(Directories) $(test_program)$(name_addition)
	$(test_program)$(name_addition)
	touch testop

force :

# ---------------------------------------------------------------

include $(dependency_files)

$(Directories) : % :
	mkdir $@

$(header_files) : $(includedir)/%.hpp : $(srcdir)/%.hpp
	cp $< $@

$(dependency_files) : $(aux_dir)/%.d : $(srcdir)/%.cpp
	$(CXX) -MM $(source_libraries) $< > $@.$$$$; \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@.$$$$$$; \
	sed 's,\($*\)\.o \(.*\)\.d [ :]*,\1.o \1$(name_addition).o \2.d : ,g' < $@.$$$$$$ > $@; \
	rm $@.$$$$ $@.$$$$$$

$(object_files_optimised) : $(libdir)/%$(name_addition).o : $(srcdir)/%.cpp
	$(CXX) -c -o $@ $(Optimisation_options) $(source_libraries) $<
$(object_files) : $(libdir)/%.o : $(srcdir)/%.cpp
	$(CXX) -c -o $@ $(General_options) $(source_libraries) $<

$(programs) : $(bindir)/% : $(libdir)/%.o
	$(CXX) -o $@ $(General_options) $< $(link_libraries)
$(programs_optimised) : $(bindir)/% : $(libdir)/%.o
	$(CXX) -o $@ $(Optimisation_options) $< $(link_libraries)


# --------------------------------

.PHONY : clean cleanobj cleandep cleanhead cleanprograms cleanall

cleanobj :
	- rm $(object_files) $(object_files_optimised)

cleandep :
	- rm $(dependency_files)

clean : cleanobj cleandep
	- rm test testop

cleanhead :
	- rm $(header_files)

cleanprograms :
	- rm $(programs) $(programs_optimised)

cleanall : clean cleanhead cleanprograms

