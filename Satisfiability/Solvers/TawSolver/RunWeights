#!/bin/bash
# Oliver Kullmann, 1.8.2013 (Swansea)
# Copyright 2013 Oliver Kullmann
# This file is part of the OKlibrary. OKlibrary is free software; you can redistribute
# it and/or modify it under the terms of the GNU General Public License as published by
# the Free Software Foundation and included in this library; either version 3 of the
# License, or any later version.

# To be run in directory OKlib/Satisfiability/Solvers/TawSolver .
# To analyse results, go into the experiment-directory, and run
# oklib --R
# > oklib_load_all()
# > E1=read_satstat("Result_tawSolver")
# > E2=read_satstat("Result_ttawSolver")

set -o errexit
set -o nounset

script_name="RunWeights"
version_number=0.0.6

if ([ $# -ne 6 ]) then
  echo -e "ERROR[${script_name}]: Precisely 6 parameters are needed:\n" \
    " the main macro, start-, end- and step-value, the CNF-file, and further options."
  exit 1
fi

mainm=$1
start=$2
end=$3
step=$4
file=$5
furtherm=$6

solver1="./tawSolver"
solver2="./ttawSolver"

timestamp=$(date +"%Y-%m-%d-%H%M%S")

expdir="Exp_weights_$1_$timestamp"
mainlog=$expdir/log
logfile1=$expdir/log1
logfile2=$expdir/log2

echo "Experiment directory: $expdir"
mkdir $expdir

date > $mainlog
echo -ne "\nMain macro: \"$mainm\"\n" >> $mainlog
echo -ne "Start, end, and step values: $start $end $step\n" >> $mainlog
echo -ne "File: $file\n" >> $mainlog
echo -ne "Further macros: \"$furtherm\"\n" >> $mainlog

make -B all
${solver1} -v > $logfile1
${solver2} -v > $logfile2

result1=$expdir/Result_tawSolver
result2=$expdir/Result_ttawSolver
temp=$expdir/tempout

echo -n "x " > $result1
ExtractTawSolver header-only >> $result1
echo -n "x " > $result2
ExtractTawSolver header-only >> $result2

x=$start
while [ $(echo "$x <= $end" | bc) -eq 1 ]; do
  make -B all CXXFLAGS="-D${mainm}=$x ${furtherm}"

  set +e
  ${solver1} $file > $temp
  set -e
  echo -e "\nx=$x" >> $logfile1
  cat $temp >> $logfile1
  echo -n "$x " >> $result1
  cat $temp | ExtractTawSolver x >> $result1

  set +e
  ${solver2} $file > $temp
  set -e
  echo -e "\nx=$x" >> $logfile2
  cat $temp >> $logfile2
  echo -n "$x " >> $result2
  cat $temp | ExtractTawSolver x >> $result2

  x=$(echo "$x + $step" | bc)
done

exit 0
